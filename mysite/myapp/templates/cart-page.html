<!DOCTYPE html>
<html lang="en">
<head>
    <title>Cart</title>
    {% include "header.html" %}
</head>
<body>
<section class="hero is-success is-fullheight">
    <!-- Hero head: will stick at the top -->
    {% include "hero-head.html" %}

<section id="cartapp">
    <!-- Hero content: will be in the middle -->
    <div class="hero-body" >
        <div class="container shopcontainer">
            <div class="columns">
                <div class="column progresssteps" >


                    <ul class="steps is-narrow is-medium is-centered has-content-centered">
                        <li class="steps-segment" v-bind:class="{'has-gaps': cart_state < 1, 'is-active':cart_state ==0}">
                            <a class="has-text-dark">
                                <span class="steps-marker">
                                <span class="icon">
                                <i class="fa fa-shopping-cart"></i>
                                </span>
                                </span>
                                <div class="steps-content">
                                    <p class="heading">Shopping Cart</p>
                                </div>
                            </a>
                        </li>
                        <li class="steps-segment"  v-bind:class="{'has-gaps': cart_state < 2, 'is-active':cart_state ==1}">
                            <a class="has-text-dark">
                                <span class="steps-marker">
                                <span class="icon">
                                <i class="fa fa-user"></i>
                                </span>
                                </span>
                                <div class="steps-content">
                                    <p class="heading">User Information</p>
                                </div>
                            </a>
                        </li>
                        <li class="steps-segment"  v-bind:class="{'has-gaps': cart_state < 3, 'is-active':cart_state ==2}">
                                <span class="steps-marker">
                                <span class="icon">
                                <i class="fas fa-rupee-sign"></i>
                                </span>
                                </span>
                                <div class="steps-content">
                                <p class="heading">Payment</p>
                            </div>
                        </li>
                        <li class="steps-segment">
                            <span class="steps-marker">
                            <span class="icon">
                            <i class="fa fa-check"></i>
                            </span>
                            </span>
                            <div class="steps-content">
                                <p class="heading">Confirmation</p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
            <div class="columns">
                <div class="column">
                    <h2 class="title is-4 carttitle" v-html="carttitlename">S</h2>
                </div>
            </div>
            <div class="columns">
                <div class="column is-one-quarters">
                    <aside class="menu">
                        <table class="table">
                            <table class="table cartmenu">
                                <tbody>
                                <tr>
                                    <th>Subtotal:</th>
                                    <td v-html="rsubtotal"></td>
                                </tr>
                                <tr>
                                    <th>Delivery Charges:</th>
                                    <td v-html="rdeliverycharge"></td>
                                </tr>
                                <tr>
                                    <th>Extra Charges:</th>
                                    <td v-html="rextracharge"></td>
                                </tr>

                                </tbody>
                            </table>
                            <table class="table cartmenu">
                                <tr class="totalrow">
                                    <th>Total:</th>
                                    <td><span v-html="rtotal"></span><br><div class="content is-small">(GST inclusive)</div></td>
                                </tr>
                            </table>
                        </table>
                    </aside>
                </div>
                <div class="column is-three-quarters prodcolumn">

                    <table v-cloak v-show="cart_state==0" class="table carttable">
                        <thead>
                        <tr>
                            <td>Product</td>
                            <td></td>
                            <td>Price</td>
                            <td>Quantity</td>
                            <td>Total</td>
                        </tr>
                        </thead>
                        <tbody>
                        <tr v-for="prod in products">
                            <td><div class="cartproddiv"><article class="media is-shady" v-on:click="open_prod_page(prod.slug)">
                                <figure class="media-left">
                                    <p class="image is-96x96">
                                        <img v-bind:src="prod.img">
                                    </p>
                                </figure>
                                <div class="media-content">
                                    <div class="content">
                                        <p class="cardhead">[%prod.title%]</p>
                                        <p class="cardsubtitle">[%prod.subtitle%]</p>
                                    </div>
                                </div>
                            </article></div></td>
                            <td><div class="content is-medium" data-balloon="Remove" data-balloon-pos="right" v-on:click="remove_prod(prod.id)"><i class="fa fa-window-close" aria-hidden="true"></i></div></td>
                            <td>₹[%prod.price%]</td>
                            <td>
                                <div class="prodquant cartquant">
                                    <a class="button is-success is-inverted increment">
                                <span class="icon" v-on:click="increase_qty(prod.id)">
                                  <i class="fas fa-plus"></i>
                                </span>
                                    </a>
                                    <span class="cart_qty">[%prod.qty%]</span>
                                    <a class="button is-success is-inverted increment">
                                <span class="icon" v-on:click="decrease_qty(prod.id)">
                                  <i class="fas fa-minus"></i>
                                </span>
                                    </a>
                                </div>
                            </td>
                            <td>₹[%prod.total%]</td>
                        </tr>
                        </tbody>
                    </table>
                    <form id="addressform" v-show="cart_state==1" v-cloak>
                        <div class="addressform" >

                        <div class="field is-horizontal">
                            <div class="field-body">
                                <div class="field">
                                    <label class="label">Name</label>
                                    <p class="control is-expanded has-icons-left">
                                        <input name="name" class="input" type="text" maxlength="30" placeholder="e.g. Donald Trump">
                                        <span class="icon is-small is-left">
                                          <i class="fas fa-user"></i>
                                        </span>
                                    </p>
                                </div>
                                <div class="field is-expanded">
                                    <label class="label">Mobile</label>
                                    <div class="field has-addons">
                                        <p class="control">
                                            <a class="button is-static">
                                                +91
                                            </a>
                                        </p>
                                        <p class="control is-expanded">
                                            <input name="mobile" class="input" type="tel" placeholder="e.g. 9123456789" maxlength="10">
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">Address Line 1</label>
                            <div class="control">
                                <input name="address1" class="input" type="text" placeholder="e.g. Flat No. / Bldg No / Area">
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">Address Line 2</label>
                            <div class="control">
                                <input name="address2" class="input" type="text" placeholder="e.g. Street Name / Landmark">
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">Pincode</label>
                            <div class="control">
                                <input name="pincode" v-model="pincode" class="input pincode" type="text" placeholder="e.g. 110006">
                                <span class="pincodedisp" v-html="pincodedisplay"></span>
                            </div>
                        </div>
                    </div>
                    </form>
                    <div style="text-align: center;">
                        <div class="buttons is-centered" v-cloak>
                            <span class="button is-warning" v-if="cart_state==0" v-on:click="checkout">Checkout</span>
                            <span class="button is-warning" v-if="cart_state==1" v-on:click="undocheckout">Back</span>
                            <span class="button is-warning" v-if="cart_state==1" v-on:click="checkout">Save</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<div class="modal blackmodal" v-bind:class="{'is-active': ModalDeleteConfirm}">
        <div class="modal-card confirm-modal bShadow-66 is-shady">
            <section class="modal-card-body">
                <div class="modalclose">
                    <span v-on:click="ModalDeleteConfirm=false">
                        <i class="fa fa-window-close" aria-hidden="true"></i>
                    </span>
                </div>
                <h2 class="title is-6">Confirm</h2>
                <p>Do you want to remove following from the cart ?</p>
                <p class="cardhead">[%confirm_name%]</p>
                <p class="cardsubtitle">[%confirm_sub%]</p>
                <p class="cardsubtitle" style="margin-left: 10px;">Quantity: [%confirm_qty%]</p>
            </section>
            <footer class="modal-card-foot">
                <button class="button is-success" v-on:click="remove()">Remove</button>
                <button class="button" v-on:click="ModalDeleteConfirm=false">Cancel</button>
            </footer>
        </div>
    </div>
</section>

    {% include "hero-footer.html" %}

<script>
    var subtotal = {{subtotal}};

    var deliverycharge = {{deliverycharge}};

    var extracharge = {{extracharge}};

    var total = {{total}};

    var products = {{cartprods | safe}};
    var prod_id_index = {{cartprods_ids | safe}};

    var cart_state = {{state}};
</script>

<script>
    var edit_cart = function edit_cart(action, cp_id) {
        head_app.loading = true;
        axios({
            method: 'post',
            url: '/api/cart/edit_cart',
            data: {
                'action': action,
                'cp_id': cp_id
            }
        }).then(function (response) {
            head_app.loading = false;
            if(response.data.success){
                cartapp.products = response.data.cartprods;
                cartapp.prod_id_index = response.data.cartprods_ids;
                cartapp.subtotal = response.data.subtotal;
                cartapp.deliverycharge = response.data.deliverycharge;
                cartapp.extracharge = response.data.extracharge;
                cartapp.total = response.data.total;
                head_app.cartqty = cartapp.products.length;
            }
            else{
                console.log(response);
                alert('Error - ' + response.data.reason);
            }
        });
    };


    var checkout = function checkout() {
        head_app.loading = true;
        axios({
            method: 'post',
            url: '/api/cart/checkout',
            data: {
                'checkout': true,
            }
        }).then(function (response) {
            head_app.loading = false;
            if(response.data.success){
                cartapp.cart_state = response.data.cart_state;
            }
            else{
                console.log(response);
                alert('Error - ' + response.data.reason);
            }
        });
    };

    var undocheckout = function undocheckout() {
        head_app.loading = true;
        axios({
            method: 'post',
            url: '/api/cart/checkout',
            data: {
                'checkout': false,
            }
        }).then(function (response) {
            head_app.loading = false;
            if(response.data.success){
                cartapp.cart_state = response.data.cart_state;
            }
            else{
                console.log(response);
                alert('Error - ' + response.data.reason);
            }
        });
    };


    var get_pincode_details = function get_pincode_details(pincode) {
        head_app.loading = true;
        axios({
            method: 'post',
            url: '/api/cart/pincode',
            data: {
                'pincode': pincode,
            }
        }).then(function (response) {
            head_app.loading = false;
            if(response.data.success){
                cartapp.pincodedisplay = response.data.pincodedisplay;
            }
            else{
                console.log(response);
                alert('Error - ' + response.data.reason);
            }
        });
    };
</script>

<script>
    var cartapp = new Vue({
        el: '#cartapp',
        delimiters: ['[%', '%]'],
        data: {
            subtotal: subtotal,
            deliverycharge: deliverycharge,
            extracharge: extracharge,
            total: total,
            products: products,
            prod_id_index: prod_id_index,
            ModalDeleteConfirm: false,
            cart_state: cart_state,
            confirm_name: '',
            confirm_sub: '',
            confirm_qty: '',
            pincode: '',
            pincodedisplay: ''
        },
        computed: {
            rsubtotal: function () {
                return '₹' + this.subtotal.toString();
            },
            rdeliverycharge: function () {
                return '₹' + this.deliverycharge.toString();
            },
            rextracharge: function () {
                return '₹' + this.extracharge.toString();
            },
            rtotal: function () {
                return '₹' + this.total.toString();
            },
            carttitlename: function(){
                if(this.cart_state==0){
                    return "Shopping Cart";
                }
                if(this.cart_state==1){
                    return "Shipping Address";
                }
                if(this.cart_state==2){
                    return "Payment Method";
                }
                if(this.cart_state==3){
                    return "Confirmation";
                }

            }

        },
        methods: {
            increase_qty: function(cp_id){
                edit_cart('increase', cp_id);
            },
            decrease_qty: function(cp_id){
                var idx = this.prod_id_index[cp_id];
                var qty = this.products[idx].qty;
                if(qty==1) {
                    this.remove_prod(cp_id);
                }
                else{
                    edit_cart('decrease', cp_id);
                }
            },
            remove_prod: function(cp_id){
                var idx = this.prod_id_index[cp_id];
                var prod = this.products[idx];
                this.confirm_name = prod.title;
                this.confirm_sub = prod.subtitle;
                this.confirm_qty = prod.qty;
                this.confirm_id = cp_id;
                this.ModalDeleteConfirm = true;
            },
            remove: function(){
                edit_cart('remove', this.confirm_id);
                this.ModalDeleteConfirm = false;
            },
            open_prod_page: function(slug){
                var url = '/product/'+slug;
                var win = window.open(url, '_blank');
                win.focus();
            },
            checkout: function(){
                checkout();
            },
            undocheckout: function(){
                undocheckout();
            },
        },
        watch: {
            pincode: function(newVal, oldVal){
                if(newVal.length==6){
                    if(!isNaN(newVal)){
                        get_pincode_details(newVal);
                    }
                }
            }
        }
    });

</script>


</section>
</body>
</html>